var wsconnected=0,lastw="",oktosend=1,connectionId=null,eline=0,okwait=0,running=0,px=0,py=0,pz=0,pe=0,etime=new Date,checktemp=1,comtype=0,egcodes=[],debugs=2;function sendgcode(e){1&debugs&&console.log(e);try{0==comtype&&writeSerial(e+"\n"),1==comtype&&ws.send(e+"\n")}catch(e){}}function nextgcode(){if((1!=comtype||wsconnected)&&!(0<okwait)&&running){for(;eline<egcodes.length;){var e=egcodes[eline];if(eline++,";PAUSE"==e&&pause(),e&&";"!=e[0]&&"("!=e[0])return okwait=1,void sendgcode(e.split(";")[0])}sendgcode("G4"),sendgcode("M114"),stopit()}}function stopit(){var e=etime.getTime();etime=new Date,console.log("Stop "+etime),e=etime.getTime()-e,mss="Real time:"+mround(e/6e4),console.log(mss),document.getElementById("btexecute").innerHTML="Print",document.getElementById("btpause").innerHTML="Pause",okwait=running=0,egcodes=[]}function execute(e){etime=new Date,console.log("Start "+etime),document.getElementById("btpause").innerHTML="PAUSE",egcodes=e.split("\n"),eline=0,running=egcodes.length,okwait=0,nextgcode()}function idleloop(){wsconnected&&checktemp&&(checktemp=0),setTimeout(idleloop,3e3)}var ss="",eeprom={},ineeprom=0,eppos=0,resp1="",onReadCallback=function(e){resp1+=e;for(var n="",o=0;o<e.length;o++)if("\n"==e[o]?(0<ss.indexOf("Z:")&&(px=parseFloat(ss.substr(ss.indexOf("X:")+2)),py=parseFloat(ss.substr(ss.indexOf("Y:")+2)),pz=parseFloat(ss.substr(ss.indexOf("Z:")+2)),pe=parseFloat(ss.substr(ss.indexOf("E:")+2))),2&debugs&&console.log(ss),ss=""):ss+=e[o],"\n"==e[o]||" "==e[o]||"*"==e[o]){if(0<ineeprom){if(20==ineeprom)eppos=lastw;else if(19==ineeprom)eeprom[eppos]=lastw;else{if(n+=lastw+" ","\n"==e[o])document.getElementById("eepromid").innerHTML+='<option value="'+eeprom[eppos]+":"+eppos+'">'+n+"</option>",ineeprom=1}ineeprom--}0<=lastw.toUpperCase().indexOf("EPR:")&&(ineeprom=20,n=""),0<=lastw.toUpperCase().indexOf("T:")&&(document.getElementById("info3d").innerHTML=lastw,checktemp=1),isok=2==lastw.length&&"O"==lastw[0].toUpperCase(),(isok||0<=lastw.toUpperCase().indexOf("OK")||0<=lastw.toUpperCase().indexOf("WAIT"))&&(okwait=0,nextgcode()),lastw=""}else lastw+=e[o]};function connectwebsock(){if(wsconnected)ws.close();else if(h=getvalue("wsip"),h){var n=comtype;comtype=1;var o=document.getElementById("status");o.innerHTML="Web socket:Connecting...",ws=new WebSocket("ws://"+h+":81/",["arduino"]),ws.onerror=function(e){comtype=n,o.innerHTML="Web socket:Failed connect ! ",$("wsconnect").innerHTML="Connect",ws.close(),wsconnected=0},ws.onmessage=function(e){msg=e.data,onReadCallback(msg)},ws.onopen=function(e){console.log("Ws Connected!"),o.innerHTML="Web socket:Connected",$("wsconnect").innerHTML="Close",wsconnected=1,nextgcode()},ws.onclose=function(e){console.log("ws Disconnected!"),(o=document.getElementById("status")).innerHTML="Web socket:disconnected",$("wsconnect").innerHTML="Connect",wsconnected=0},idleloop()}}window.onload=function(){var e=window.location.host;a=document.activeElement,"DIV"==a.tagName&&1==stotype&&a.remove(),e&&setvalue("wsip",e)};